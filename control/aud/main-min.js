$((function(){"use strict";function t(t){let a="";switch(t){case"A":a="Alta";break;case"B":a="Baja";break;case"M":a="Modificación";break;case"P":a="Proceso";break;default:a=row.tipo;break}return a}function a(t,a,e=""){let o=moment(t,"YYYY"),i=moment(a,"YYYY");e=e||a,$("#_dr").daterangepicker({singleDatePicker:!1,showDropdowns:!0,minYear:parseInt(o),maxYear:parseInt(i),startDate:e,endDate:a,minDate:t,maxDate:a,showWeekNumbers:!1,autoUpdateInput:!0,opens:"center",drops:"down",autoApply:!1,alwaysShowCalendars:!0,linkedCalendars:!1,buttonClasses:"btn btn-sm fontq",applyButtonClasses:"btn-custom  border fw4 px-3 opa8",cancelClass:"btn-link fw4 text-gris",ranges:{Hoy:[moment(),moment()],Ayer:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Ultimos 7 Días":[moment().subtract(6,"days"),moment()],"Ultimos 30 Días":[moment().subtract(29,"days"),moment()],"Este Mes":[moment().startOf("month"),moment().endOf("month")],"Ultimo Mes":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"Todo el Periodo":[t,a]},locale:{format:"DD/MM/YYYY",separator:" al ",applyLabel:"Aplicar",cancelLabel:"Cancelar",fromLabel:"Desde",toLabel:"Para",customRangeLabel:"Personalizado",weekLabel:"Sem",daysOfWeek:["Do","Lu","Ma","Mi","Ju","Vi","Sa"],monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],firstDay:1,alwaysShowCalendars:!0,applyButtonClasses:"btn-custom fw5 px-3 opa8"}}),$("#_dr").on("apply.daterangepicker",(function(t,a){CheckSesion(),$("#tableAuditoria").DataTable().ajax.reload()}))}let e=$("#tableAuditoria").dataTable({lengthMenu:[[5,10,25,50,100],[5,10,25,50,100]],bProcessing:!1,serverSide:!0,deferRender:!0,responsive:!0,dom:"<'row fila invisible animate__animated animate__fadeInDown'<'col-12 col-sm-6 d-flex justify-content-start'<'filtros'>l><'col-12 col-sm-6 d-flex justify-content-end'<'ml-1 _dr'><'refresh'>>><'row'<'col-12 divFiltros'>><'row fila invisible animate__animated animate__fadeInDown'<'col-12'f>><'row animate__animated animate__fadeIn'<'col-12 table-responsive'tr>><'row animate__animated animate__fadeIn'<'col-12 col-sm-5'i><'col-12 col-sm-7 d-flex justify-content-end'p>>",ajax:{url:"getAuditoria.php?"+$.now(),type:"POST",dataType:"json",data:function(t){t._dr=$("#_dr").val(),t.nombreAud=$("#nombreAud").val(),t.tipoAud=$("#tipoAud").val(),t.userAud=$("#userAud").val(),t.idSesionAud=$("#idSesionAud").val(),t.horaAud=$("#horaAud").val(),t.horaAud2=$("#horaAud2").val(),t.cuentaAud=$("#cuentaAud").val()},error:function(){$("#tablePersonal").css("display","none")}},createdRow:function(t,a,e){$(t).attr({"data-id":a.id,"data-idsesion":a.id_sesion,title:"Ver detalle"})},columns:[{className:"",targets:"",title:"<span data-titler='Nombre / Usuario'>Usuario</span>",render:function(t,a,e,o){return'<div><div class="fw5">'+e.nombre+"</div><div>"+e.usuario+"</div></div>"}},{className:"text-center",targets:"",title:"ID Sesion",render:function(t,a,e,o){return"<div>"+e.id_sesion+"</div>"}},{className:"",targets:"",title:"Cuenta",render:function(t,a,e,o){return"<div>"+e.audcuenta_nombre+"</div>"}},{className:"",targets:"",title:"Fecha Hora",render:function(t,a,e,o){return"<div class='ls1'>"+moment(e.fecha).format("DD/MM/YYYY")+"</div><div class='ls1'>"+e.hora+"</div>"}},{className:"text-center",targets:"",title:"<span data-titlel='Tipo de registro'>Tipo</span>",render:function(a,e,o,i){return'<div data-titlel="'+t(o.tipo)+'">'+o.tipo+"</div>"}},{className:"w-100",targets:"",title:"<span data-titlel='Información de la auditoría'>Dato</span>",render:function(t,a,e,o){return'<div data-titlel="'+e.dato+'">'+e.dato+"</div>"}}],paging:!0,searching:!0,info:!0,ordering:0,responsive:0,language:{url:"../../js/DataTableSpanishShort2.json?"+vjs()}});e.on("init.dt",(function(t,e){$("#tableAuditoria_length select").addClass("h35"),$("#tableAuditoria_filter input").attr("placeholder","Buscar dato.."),$("#tableAuditoria_filter input").attr("id","datosAud"),$("#tableAuditoria_filter input").attr("autoc","datosAud"),$("#tableAuditoria_filter input").attr("autocomplete","off"),fetch("getFechas.php").then((t=>t.json())).then((t=>{$("._dr").html('<label><input readonly title="Filtrar Fecha" type="text" id="_dr" class="form-control h35 text-center ls1 w250 bg-white" autocomplete=off></label>'),$(".refresh").html('<label><button data-titlel="Actualizar Grilla"class="btn ml-1 h35 btn-custom fontq" id="refresh"><i class="bi bi-arrow-repeat"></i></button></label>'),$(".filtros").html('<div class="d-inline-flex align-items-center"><button data-titler="Filtros" class="btn h35 btn-outline-custom border fontq" id="filtros" type="button" data-toggle="collapse" data-target="#collapseFiltros" aria-expanded="false" aria-controls="collapseFiltros"><i class="bi bi-funnel"></i></button><button id="trash_all" data-titler="Limpiar Filtros" class="bi bi-trash fontq text-secondary pointer btn h35 btn-outline-custom border fontq border-0"></button></div>'),fetch("filtros.php").then((t=>t.text())).then((t=>{$(".divFiltros").html(t),$(".fila").removeClass("invisible")})),a(moment(t.start_date).format("DD/MM/YYYY"),moment(t.end_date).format("DD/MM/YYYY"));let e=moment($("#_dr").data("daterangepicker").endDate._d).format("YYYYMMDD");$("#refresh").on("click",(function(){fetch("getFechas.php").then((t=>t.json())).then((t=>{let o=moment($("#_dr").data("daterangepicker").startDate._d).format("DD/MM/YYYY"),i=moment(t.end_date).format("DD/MM/YYYY"),l=moment(t.end_date).format("YYYYMMDD"),d=parseInt(e)<parseInt(l)?l:e;parseInt(e)<parseInt(d)?(a(o,i,o),e=d,$("#tableAuditoria").DataTable().ajax.reload()):$("#tableAuditoria").DataTable().ajax.reload(null,!1)}))}))})),$("#"+t.target.id).children("tbody").on("click","tr",(function(){CheckSesion();let a=$("#"+t.target.id).DataTable().row($(this)).data();fetch("modal.html?v="+vjs()).then((t=>t.text())).then((t=>{$("#modalAuditoria").html(t),$("#modalAuditoria .modal-title").html("Detalle de Auditoría"),$("#detalleAud").modal("show"),$("#detalleAud .l div").addClass("bg-light text-light"),fetch("getDetalle.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"i="+a.id+"&s="+a.id_sesion}).then((t=>t.json())).then((t=>{1==t.data&&($("#modalAuditoria #aud_nomb").html(t.aud_nomb),$("#modalAuditoria #aud_user").html(t.aud_user),$("#modalAuditoria #aud_nacu").html(t.aud_nacu),$("#modalAuditoria #aud_fech").html(t.aud_fech),$("#modalAuditoria #aud_hora").html(t.aud_hora),$("#modalAuditoria #aud_tipo").html(t.aud_tipn),$("#modalAuditoria #aud_modu").html(t.aud_modu),$("#modalAuditoria #aud_dato").html(t.aud_dato),$("#modalAuditoria #log_fech").html(t.log_fech),$("#modalAuditoria #log_hora").html(t.log_hora),$("#modalAuditoria #log_idse").html(t.log_idse),$("#modalAuditoria #log_nrol").html(t.log_nrol),$("#modalAuditoria #log_d_ip").html(t.log_d_ip),$("#modalAuditoria #log_agen").html(t.log_age1+". "+t.log_age2+": "+t.log_age3),$("#detalleAud").on("hidden.bs.modal",(function(t){$("#modalAuditoria").html("")})),$("#detalleAud .l div").removeClass("bg-light text-light"),$("#detalleAud .l div").addClass("animate__animated animate__fadeIn"))}))}))}))})),e.on("page.dt",(function(t,a){CheckSesion(),$("#"+t.target.id+" div").addClass("bg-light text-light")})),e.on("draw.dt",(function(t,a){$("#"+t.target.id+" div").removeClass("bg-light text-light"),$("#divTableAud").show(),$(t.target.id+"_previous").attr("data-titlel","Anterior"),$(t.target.id+"_next").attr("data-titlel","Siguiente")}))}));